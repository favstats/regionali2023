---
title: "Elezioni regionali in Lombardia e Lazio del 2023"
subtitle: "How Do Political Campaigns Target Voters?"
author: "Fabio Votta (@favstats)"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
---

<style>
    body .main-container {
        max-width: 1920px !important;
    }
</style>


```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(
    cache = T, 
    echo = F, 
    warning = F, 
    message = F, 
    cache.lazy = FALSE
)


# pacman::p_load(tidyverse, highcharter)
library(tidyverse)
library(highcharter)
library(gt)



options(scipen = 999)

# source("helpers.R")

# pro_reps <- us_advertisers %>% 
#   filter(left_vs_right == "All Republican-supporting pages")

# source("utils.R")
```

```{r}

election_dat30 <- readRDS("data/election_dat30.rds") %>% 
    filter(party != "Unione Popolare") %>% 
    mutate(coalition = str_replace(coalition, "Movimente", "Movimento"))
election_dat7 <- readRDS("data/election_dat7.rds") %>% 
    filter(party != "Unione Popolare") %>% 
    mutate(coalition = str_replace(coalition, "Movimente", "Movimento"))

lazio7 <- election_dat7 %>% 
    filter(election == "Lazio")

lombardy7 <- election_dat7 %>% 
    filter(election == "Lombardia")


lazio30 <- election_dat30 %>% 
    filter(election == "Lazio")

lombardy30 <- election_dat30 %>% 
    filter(election == "Lombardia")

lab_dat <- readRDS("data/lab_dat.rds")

main7 <- election_dat7 %>% 
    filter(election == "Main party" | election == "Main party")


main30 <- election_dat30 %>% 
    filter(election == "Main party" | election == "Main party")


last7days_string <- "3 febbraio - 9 febbraio 2023"
last30days_string <- "11 gennaio - 9 febbraio 2023"
```

```{r}


calc_targeting <- function(only_tags) {
 
total_sppppeen <- only_tags %>% 
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_spend = sum(total_spend))

howmuchisinterest <- only_tags %>% 
  filter(type == "detailed") %>%   
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  arrange(desc(spend_per)) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  mutate(target = "interest")

howmuchislocation <- only_tags %>% 
  filter(type == "location") %>%   
  group_by(internal_id, location_type) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per, location_type) %>% 
  arrange(desc(spend_per)) %>% 
  group_by(location_type) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  rename(target = location_type) 

howmuchisage <- only_tags %>% 
  filter(type == "age") %>%   
  filter(total_spend_pct != 0) %>% 
  group_by(internal_id) %>%
  mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  ungroup() %>% 
  filter(n_ages <= 47) %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "age")

howmuchisgender <- only_tags %>% 
  filter(type == "gender") %>%   
  filter(total_spend_pct != 0) %>% 
  filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "gender")

howmuchcustom <- only_tags %>% 
  filter(type == "custom_audience") %>%   
  filter(total_spend_pct != 0) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "custom_audience")


howmuchlookalike <- only_tags %>% 
  filter(type == "lookalike_audience") %>%   
  filter(total_spend_pct != 0) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "lookalike_audience")

howmuchlanguage <- only_tags %>% 
  filter(type == "language") %>%   
  filter(total_spend_pct != 0) %>% 
  drop_na(value) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "language")

targeting_on_each <- howmuchisinterest %>% 
  bind_rows(howmuchislocation) %>% 
  bind_rows(howmuchisage) %>% 
  bind_rows(howmuchisgender) %>% 
  bind_rows(howmuchcustom) %>% 
  bind_rows(howmuchlookalike) %>% 
  bind_rows(howmuchlanguage) %>% 
  mutate(total = total_sppppeen$total_spend) %>% 
  mutate(perc = spend_per/total*100) %>% 
  arrange(desc(perc))

return(targeting_on_each)   
}
```


## Methodology

We coded over 300 Italian political advertisers during the 2023 regional to better understand how campaigns use different targeting methods made available by Meta. To do this, we used data from the [Meta Ad Library](https://www.facebook.com/ads/library/), using the new 'Audience' data which gives some detail on how pages target their ads.

To better understand the regional election, we kept only advertisers who:

1. Advertised in the last 7 days (`r last7days_string`)
2. Advertised in the last 30 days (`r last30days_string`)


before election day.

> Note: Meta only provides 7, 30 and 90 days windows for the targeting data in their Ad Library. Meta's data also lags by a few days. We will update this report as soon as new data is available. 


## Statistiche di prima linea  {.tabset .tabset-fade .tabset-pills}


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}
# runoff %>% count(ds)
```


```{r}

get_table_dat <- function(x, var) {
    
    

x %>% 
        distinct(internal_id, .keep_all = T) %>% 
    group_by({{ var }}) %>% 
    summarize(total_num_ads = n()) %>% 
    drop_na() %>% 
    mutate(total_num_ads = scales::comma(total_num_ads)) %>%
    pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
    mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>% 
    bind_rows(x %>% 
        distinct(internal_id, .keep_all = T) %>% 
        group_by({{ var }}) %>% 
        arrange(desc(total_spend_formatted)) %>% 
        slice(1:3) %>% 
        mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%
        mutate(n_words = str_count(page_name, " ")) %>% 
        mutate(lab = paste0(word(str_remove(page_name, "-"), 1,ifelse(n_words>=2, 3, 2), sep=" "), "<br>(€", total_spend_formatted, ")")) %>% 
        # mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>% 
        select({{ var }}, lab) %>% 
        drop_na() %>% 
        summarize(lab = paste0("<br>", 1:n(), ". ", lab, collapse = "")) %>% 
        pivot_wider(names_from = {{ var }}, values_from = lab) %>% 
        mutate(`Coalizione/Partito` = "Chi ha\nspeso di più"))  %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_num_ads = sum(total_num_ads)) %>% 
            drop_na() %>% 
            mutate(total_num_ads = scales::comma(total_num_ads)) %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
            mutate(`Coalizione/Partito` = "Numero di annunci")) %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_spend_formatted = sum(total_spend_formatted)) %>% 
            mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% 
        mutate(total_spend_formatted = paste0("€", total_spend_formatted)) %>% 
            drop_na() %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_spend_formatted) %>% 
            mutate(`Coalizione/Partito` = "Spesa Totale") ) %>% 
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("Coalizione/Partito") %>% 
    set_names(.[nrow(.),] %>% as.character()) %>% 
    slice(1:(n()-1)) 
    
}


get_table_dat(lombardy30, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0039aa",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))




```




##### `r last7days_string` (Ultimi 7 giorni)


```{r}

get_table_dat(lombardy7, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0039aa",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}

add_ribbons <- function(x, adv, col) {
   x %>% 
  tab_options(table.width = pct(100)) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = col,
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = adv
    ))
}

get_table_dat(lombardy30, party) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538()  %>%
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    add_ribbons("Majorino Presidente", "#febb00") %>%
    add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Più Europa Radicali Volt", "#008000") %>%
    add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r}


get_table_dat(lombardy7, party) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  # left_join(lab_dat  %>% 
  #               filter(election == "Lombardy") %>% 
  # mutate(`Coalizione/Partito` = ifelse(str_detect(party,  "Azione"), "Azione - Italia Viva", party)) %>% 
  #   distinct(`Coalizione/Partito`, coalition) %>% mutate(Coalizione = `Coalizione/Partito`)) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538()  %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    add_ribbons("Majorino Presidente", "#febb00") %>%
    add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Più Europa Radicali Volt", "#008000") %>%
    add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    )) # %>%
  # gtExtras::gt_merge_stack(col1 = Coalizione, col2 = coalition)
```


```{r}
# library(gtExtras)
# team_df <- readRDS(url("https://github.com/nflverse/nflfastR-data/raw/master/teams_colors_logos.rds"))
# 
# team_df %>%
#   dplyr::select(team_nick, team_abbr, team_conf, team_division, team_wordmark) %>%
#   head(8) %>%
#   gt(groupname_col = "team_conf") %>%
#   gt_merge_stack(col1 = team_nick, col2 = team_division)
```


### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

#####  `r last30days_string` (Ultimi 30 giorni)

```{r}
# runoff %>% count(ds)
```


```{r}

get_table_dat(lazio30, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#fff44f",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione Movimento 5 Stelle"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



##### `r last7days_string` (Ultimi 7 giorni)


```{r}

get_table_dat(lazio7, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#fff44f",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione Movimento 5 Stelle"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}

get_table_dat(lazio30, party) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Europa"), "Piu Europa Radicali Volt", `Coalizione/Partito`)) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Piu Europa Radicali Volt", "#ffd700") %>% 
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    # add_ribbons("Majorino Presidente", "#febb00") %>%
    # add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
    add_ribbons("UdC", "#87cefa") %>% 
    add_ribbons("Lista Civica D'Amato", "#0062a6") %>% 
    add_ribbons("Lista Civica Rocca", "#e20613") %>% 
    add_ribbons("Polo Progressista", "#e52728") %>% 
    add_ribbons("Demos", "#449192") %>% 
    add_ribbons("Psi", "#dc143c")  %>% 
    
     
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r}

get_table_dat(lazio7, party) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Europa"), "Piu Europa Radicali Volt", `Coalizione/Partito`)) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Piu Europa Radicali Volt", "#ffd700") %>% 
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    # add_ribbons("Majorino Presidente", "#febb00") %>%
    # add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
    add_ribbons("UdC", "#87cefa") %>% 
    add_ribbons("Lista Civica D'Amato", "#0062a6") %>% 
    add_ribbons("Lista Civica Rocca", "#e20613") %>% 
    add_ribbons("Polo Progressista", "#e52728") %>% 
    add_ribbons("Demos", "#449192") %>% 
    add_ribbons("Psi", "#dc143c")  %>% 
    
     
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



<!-- ### Principali partiti politici  {.tabset .tabset-fade .tabset-pills} -->

<!-- #### Nov 30th - Dec 6th 2022 (Last 30 Days) -->

<!-- ```{r} -->
<!-- # runoff %>% count(ds) -->
<!-- ``` -->


<!-- ```{r} -->

<!-- main30 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--     group_by(coalition) %>%  -->
<!--     summarize(total_num_ads = n()) %>%  -->
<!--     drop_na() %>%  -->
<!--     mutate(total_num_ads = scales::comma(total_num_ads)) %>% -->
<!--     pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--     mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>%  -->
<!-- bind_rows( -->
<!--     main30 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--         group_by(coalition) %>%  -->
<!--         arrange(desc(total_spend_formatted)) %>%  -->
<!--         slice(1:3) %>%  -->
<!--         mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% -->
<!--         mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>%  -->
<!--         select(coalition, lab) %>%  -->
<!--         drop_na() %>%  -->
<!--         summarize(lab = paste0("<br>", 1:3, ". ", lab, collapse = "")) %>%  -->
<!--         pivot_wider(names_from = coalition, values_from = lab) %>%  -->
<!--         mutate(`Coalizione/Partito` = "Chi ha speso di più") -->
<!-- )  %>%  -->

<!--     bind_rows( -->
<!--         main30 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_num_ads = sum(total_num_ads)) %>%  -->
<!--             drop_na() %>%  -->
<!--             mutate(total_num_ads = scales::comma(total_num_ads)) %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Numero di annunci") -->
<!--     )%>%  -->
<!--     bind_rows( -->
<!--         main30 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_spend_formatted = sum(total_spend_formatted)) %>%  -->
<!--             mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%  -->
<!--             drop_na() %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_spend_formatted) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Spesa Totale (Euro)")  -->
<!--     ) %>%  -->
<!--     t() %>%  -->
<!--     as.data.frame() %>%  -->
<!--     rownames_to_column("Coalizione/Partito") %>%  -->
<!--     set_names(.[nrow(.),] %>% as.character()) %>%  -->
<!--     slice(1:(n()-1)) %>%  -->



<!--   gt( -->
<!--     rowname_col = "Coalizione/Partito" -->
<!--     # groupname_col = "group" -->
<!--   ) %>%  -->
<!--   fmt_markdown(columns = everything()) -->
<!-- ``` -->



<!-- #### Nov 30th - Dec 6th 2022 (Last 7 Days) -->


<!-- ```{r} -->

<!-- main7 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--     group_by(coalition) %>%  -->
<!--     summarize(total_num_ads = n()) %>%  -->
<!--     drop_na() %>%  -->
<!--     mutate(total_num_ads = scales::comma(total_num_ads)) %>% -->
<!--     pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--     mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>%  -->
<!-- bind_rows( -->
<!--     main7 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--         group_by(coalition) %>%  -->
<!--         arrange(desc(total_spend_formatted)) %>%  -->
<!--         slice(1:3) %>%  -->
<!--         mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% -->
<!--         mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>%  -->
<!--         select(coalition, lab) %>%  -->
<!--         drop_na() %>%  -->
<!--         summarize(lab = paste0("<br>", 1:3, ". ", lab, collapse = "")) %>%  -->
<!--         pivot_wider(names_from = coalition, values_from = lab) %>%  -->
<!--         mutate(`Coalizione/Partito` = "Chi ha speso di più") -->
<!-- )  %>%  -->

<!--     bind_rows( -->
<!--         main7 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_num_ads = sum(total_num_ads)) %>%  -->
<!--             drop_na() %>%  -->
<!--             mutate(total_num_ads = scales::comma(total_num_ads)) %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Numero di annunci") -->
<!--     )%>%  -->
<!--     bind_rows( -->
<!--         main7 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_spend_formatted = sum(total_spend_formatted)) %>%  -->
<!--             mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%  -->
<!--             drop_na() %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_spend_formatted) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Spesa Totale (Euro)")  -->
<!--     ) %>%  -->
<!--     t() %>%  -->
<!--     as.data.frame() %>%  -->
<!--     rownames_to_column("Coalizione/Partito") %>%  -->
<!--     set_names(.[nrow(.),] %>% as.character()) %>%  -->
<!--     slice(1:(n()-1)) %>%  -->



<!--   gt( -->
<!--     rowname_col = "Coalizione/Partito" -->
<!--     # groupname_col = "group" -->
<!--   ) %>%  -->
<!--   fmt_markdown(columns = everything()) -->
<!-- ``` -->



## Spesa, suddivisa per metodo di targeting {.tabset .tabset-fade .tabset-pills}

Quanto hanno speso le campagne per diversi metodi di targeting?


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)



```{r, fig.width=11, fig.height=5, dpi=300}


col_each_lombardy30 <- lombardy30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


# calc_targeting()

# 
# spend_on_each_lombardy30 %>% 
#     ggplot(aes(target, perc)) +
#     geom_col(aes(fill = coalition)) +
#     coord_flip() +
#     facet_wrap(~coalition) +
#     theme(legend.position = "none")


col_each_lombardy30 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione di centro",
                                  "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = coalition)) +
    coord_flip() +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=5, dpi=300}

col_each_lombardy7 <- lombardy7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



col_each_lombardy7 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione di centro",
                                  "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = coalition)) +
    coord_flip() +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lombardy30 <- lombardy30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



par_each_lombardy30 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Coalizione di centro",
    #                               "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lombardy7 <- lombardy7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



par_each_lombardy7 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Coalizione di centro",
    #                               "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```

### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)



```{r, fig.width=11, fig.height=5, dpi=300}


col_each_lazio30 <- lazio30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


# calc_targeting()

# 
# spend_on_each_lazio30 %>% 
#     ggplot(aes(target, perc)) +
#     geom_col(aes(fill = coalition)) +
#     coord_flip() +
#     facet_wrap(~coalition) +
#     theme(legend.position = "none")


col_each_lazio30 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione di centro",
                                  "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = coalition)) +
    coord_flip() +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=5, dpi=300}

col_each_lazio7 <- lazio7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



col_each_lazio7 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione di centro",
                                  "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = coalition)) +
    coord_flip() +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lazio30 <- lazio30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



par_each_lazio30 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Coalizione di centro",
    #                               "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lazio7 <- lazio7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



par_each_lazio7 %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc)) %>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Coalizione di centro",
    #                               "Coalizione di centro-destra"))) %>%
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

```

## Top Contested (Interest) Audiences {.tabset .tabset-fade .tabset-pills}

Here, we show the *top most contested interest audiences*, i.e. where all coalitions/parties have spent considerable amounts of money competing to reach voters with the same interests.


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}

#### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width  = 10, fig.height=15}
get_contested_graph <- function(ppp, col_string, col_colors) {
    
    
interest_targeting <-  ppp %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(type == "detailed") %>%
    # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
    mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>%
    mutate(total_spend = total_spend * total_spend_pct) %>%
    filter(main_currency == "EUR")  %>%
    # left_join(page_names %>% select(internal_id = page_id, page_name) %>% distinct(internal_id, .keep_all =T)) %>%
    # left_join(us_advertisers %>% rename(internal_id = page_id)) %>%
    # drop_na(left_vs_right) %>%
    mutate(value = paste0(detailed_type,": ", value)) %>% 
    group_by(coalition, value, is_exclusion, detailed_type) %>%
    summarise(total_spend = sum(total_spend)) %>%
    ungroup() %>%
    arrange(desc(total_spend)) 

contested_dat <- interest_targeting %>% 
    filter(coalition != "Unione Popolare") %>% 
  filter(!is_exclusion) %>% 
  # filter(total_spend >= 40000) %>% 
  filter(total_spend >= 100) %>%
  add_count(value) %>% 
  filter(n == 3) %>% 
  group_by(value) %>% 
  mutate(total_spenderino = sum(total_spend)) %>% 
  mutate(perc = total_spend/total_spenderino) %>%
  mutate(value = str_remove_all(value, "INTERESTS: |DEMOGRAPHICS: |BEHAVIORS: ")) %>% 
  mutate(value = str_replace_all(value, " \\s*\\([^\\)]+\\)", ""))


the_order <- contested_dat %>% 
  filter(coalition == "Coalizione di centro-destra") %>%   arrange(desc(perc)) %>% 
  pull(value) %>% 
  unique()

lab_dat <- contested_dat %>% 
  # distinct(value, .keep_all = T) %>% 
  filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(labb = paste0("€", scales::comma(round(total_spenderino)))) %>% 
  select(coalition, value, labb)



contested_dat %>% #count(coalition) %>% pull(coalition) %>% unique() %>% dput()
  # mutate(the_order = )
  left_join(lab_dat) %>% 
  mutate(value = factor(value, the_order)) %>% 
  mutate(coalition = factor(coalition, col_string)) %>%
  # filter()
  ggplot(aes(value, perc)) +
  geom_col(aes(fill = coalition), position = position_stack(), alpha = 0.8) +
  coord_flip() +
  geom_label(aes(label = labb),y=1.225,
            position = position_stack(vjust = 0.5),
            hjust = 1, label.size = NA,
            size = 4) + expand_limits(y = 1.2) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  # scale_fill_manual("Page Groups", values = c("#ff2700", "#008fd5")) +
  ggthemes::theme_hc() +
  labs(x = "Targeting criteria", y = "% of budget spent on targeting method", #title = "Contested targeted interests (US midterms 2022)", subtitle = " ", 
       caption = "Source: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).") +
  theme(legend.position = "bottom", plot.title = element_text(size = 28, face = "bold", hjust = 1.25), text=element_text(family="mono", face = "bold"), plot.caption = element_text(hjust = -1.7)) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))  +
    scale_fill_manual(values = col_colors)
    
}


# c("Coalizione di centro", "Coalizione di centro-destra", "Coalizione di centro-sinistra", 
# "Unione Popolare")
```


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lombardy30, c("Coalizione di centro-sinistra", "Coalizione di centro", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#0039aa", "#0a6be1") %>% rev)
```


#### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width  = 10, fig.height=15}

get_contested_graph(lombardy7, c("Coalizione di centro-sinistra", "Coalizione di centro", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#0039aa", "#0a6be1") %>% rev)
```

### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lazio30, c("Coalizione di centro-sinistra", "Coalizione Movimento 5 Stelle", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#fff44f", "#0a6be1") %>% rev)

   
```


#### `r last7days_string` (Ultimi 7 giorni)


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lazio7, c("Coalizione di centro-sinistra", "Coalizione Movimento 5 Stelle", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#fff44f", "#0a6be1") %>% rev)
```

## Rest


```{r, eval = F}
interest_targeting %>% 
  filter(is_exclusion) %>% 
  # filter(is.na(page_id)) %>% 
  mutate(value = str_remove_all(value, "INTERESTS: |DEMOGRAPHICS: |BEHAVIORS: ")) %>% 
  mutate(value = str_trunc(value, 30)) %>% 
  group_by(coalition)  %>% 
  arrange(desc(total_spend)) %>% 
  distinct(value, .keep_all = T) %>% 
  slice(1:20)  %>%
  ungroup() %>% 
  mutate(value = fct_reorder(value, total_spend)) %>% 
  ggplot(aes(value, total_spend, fill = coalition)) +
  geom_col() +
  facet_wrap(~coalition, scales = "free") +
  coord_flip()  +
  # scale_fill_manual("Page Groups", values = c("#008fd5", "#ff2700")) +
  ggthemes::theme_hc() +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Interest Exlcusion", y = "\nTotal spent on ads that exclude audience (in $)", 
       caption = "Source: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).") +
	scale_y_continuous(labels = scales::label_number(suffix = "k", scale = 1e-3)) 
```

