---
title: "Elezioni regionali in Lombardia e Lazio del 2023"
subtitle: "Quali Sono le Strategie di Targeting Utilizzate dalle Campagne Politiche?"
author: "Fabio Votta - @favstats"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
---

<style>
    body .main-container {
        max-width: 1920px !important;
    }
</style>


```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(
    cache = T, 
    echo = F, 
    warning = F, 
    message = F, 
    cache.lazy = FALSE
)


# pacman::p_load(tidyverse, highcharter)
library(tidyverse)
library(highcharter)
library(gt)



options(scipen = 999)

# source("helpers.R")

# pro_reps <- us_advertisers %>% 
#   filter(left_vs_right == "All Republican-supporting pages")

# source("utils.R")
```

```{r}

lab_dat <- readRDS("data/lab_dat.rds")



election_dat30 <- readRDS("data/election_dat30.rds") %>% 
    filter(party != "Unione Popolare") %>% 
    mutate(election = ifelse(page_name == "Maurizio Lupi", "Lombardia", election)) %>% 
    mutate(coalition = ifelse(coalition == "Coalizione di centro", "Terzo Polo", coalition))

election_dat7 <- readRDS("data/election_dat7.rds") %>% 
    filter(party != "Unione Popolare") %>% 
    mutate(election = ifelse(page_name == "Maurizio Lupi", "Lombardia", election))  %>% 
    mutate(coalition = ifelse(coalition == "Coalizione di centro", "Terzo Polo", coalition))

# election_dat7 %>% 
#     count(party, page_name) %>% 
#     count(page_name, sort = T)

lazio7 <- election_dat7 %>% 
    filter(election == "Lazio")

lombardy7 <- election_dat7 %>% 
    filter(election == "Lombardia")


lazio30 <- election_dat30 %>% 
    filter(election == "Lazio")

lombardy30 <- election_dat30 %>% 
    filter(election == "Lombardia")


main7 <- election_dat7 %>% 
    filter(election == "Main party" | election == "Main party")


main30 <- election_dat30 %>% 
    filter(election == "Main party" | election == "Main party")


last7days_string <- "5 febbraio - 11 febbraio 2023"
last30days_string <- "13 gennaio - 11 febbraio 2023"

# election_dat30 %>% 
    
# lazio7 %>% 
#     filter(page_name == "Giancarlo Righini") %>%
#     count(value, sort = T)
#     count(page_name, sort = T)

# election_dat30 %>%
#     filter(party == "Noi moderati e Rinascimento")
#     count(party, sort = T)
#     
# dir("9th/30", full.names = T) %>% 
#     map_dfr(readRDS) %>%
#     left_join(lab_dat %>% rename(internal_id = page_id)) %>% 
#     filter(party == "Noi moderati e Rinascimento")

# election_dat30 %>% 
#     count(coalition)
```

```{r}


calc_targeting <- function(only_tags) {
 
total_sppppeen <- only_tags %>% 
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_spend = sum(total_spend))

howmuchisinterest <- only_tags %>% 
  filter(type == "detailed") %>%   
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  arrange(desc(spend_per)) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  mutate(target = "interest")

howmuchislocation <- only_tags %>% 
  filter(type == "location") %>%   
  group_by(internal_id, location_type) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per, location_type) %>% 
  arrange(desc(spend_per)) %>% 
  group_by(location_type) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  rename(target = location_type) 

howmuchisage <- only_tags %>% 
  filter(type == "age") %>%   
  filter(total_spend_pct != 0) %>% 
  group_by(internal_id) %>%
  mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  ungroup() %>% 
  filter(n_ages <= 47) %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>% 
  ungroup() %>% 
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "age")

howmuchisgender <- only_tags %>% 
  filter(type == "gender") %>%   
  filter(total_spend_pct != 0) %>% 
  filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "gender")

howmuchcustom <- only_tags %>% 
  filter(type == "custom_audience") %>%   
  filter(total_spend_pct != 0) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "custom_audience")


howmuchlookalike <- only_tags %>% 
  filter(type == "lookalike_audience") %>%   
  filter(total_spend_pct != 0) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "lookalike_audience")

howmuchlanguage <- only_tags %>% 
  filter(type == "language") %>%   
  filter(total_spend_pct != 0) %>% 
  drop_na(value) %>% 
  # filter(value != "All") %>% 
  group_by(internal_id) %>%
  filter(total_spend_pct == max(total_spend_pct)) %>%
  slice(1) %>%
  ungroup() %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  select(internal_id, spend_per) %>% 
  summarize(spend_per = sum(spend_per))  %>% 
  mutate(target = "language")

targeting_on_each <- howmuchisinterest %>% 
  bind_rows(howmuchislocation) %>% 
  bind_rows(howmuchisage) %>% 
  bind_rows(howmuchisgender) %>% 
  bind_rows(howmuchcustom) %>% 
  bind_rows(howmuchlookalike) %>% 
  bind_rows(howmuchlanguage) %>% 
  mutate(total = total_sppppeen$total_spend) %>% 
  mutate(perc = spend_per/total*100) %>% 
  arrange(desc(perc))

return(targeting_on_each)   
}

relationshipstuff <- "[r|R]elationship|Parents|Partner|Separated|Divorced|Single|Complicated|Married|Engaged|Newlywed|Civil Union|Unspecified"
```


## Metodologia

<!-- We coded over 300 Italian political advertisers during the 2023 regional to better understand how campaigns use different targeting methods made available by Meta. To do this, we used data from the [Meta Ad Library](https://www.facebook.com/ads/library/), using the new 'Audience' data which gives some detail on how pages target their ads. -->

<!-- To better understand the regional election, we kept only advertisers who: -->

<!-- 1. Advertised in the last 7 days (`r last7days_string`) -->
<!-- 2. Advertised in the last 30 days (`r last30days_string`) -->


<!-- before election day. -->

<!-- > Note: Meta only provides 7, 30 and 90 days windows for the targeting data in their Ad Library. Meta's data also lags by a few days. We will update this report as soon as new data is available.  -->

Abbiamo codificato oltre 300 inserzionisti politici italiani durante le elezioni regionali del 2023 per capire meglio come le campagne utilizzino diversi metodi di targeting dei destinatari resi disponibili da Meta. Per farlo, abbiamo utilizzato i dati della Meta Ad Library, utilizzando i nuovi dati 'Pubblico' che forniscono alcuni dettagli su come le pagine scelgono a chi mostrare i loro annunci.

Per capire meglio le elezioni regionali, abbiamo mantenuto solo gli inserzionisti che:

1. Hanno pubblicizzato negli ultimi 7 giorni (5 febbraio - 11 febbraio 2023)
2. Hanno pubblicizzato negli ultimi 30 giorni (13 gennaio - 11 febbraio 2023)

> Nota: Meta fornisce solo finestre di 7, 30 e 90 giorni per i dati di selezione dei destinatari nella loro Ad Library. I dati di Meta anche hanno qualche giorno di ritardo. Aggiorneremo questo rapporto non appena saranno disponibili nuovi dati.

## Statistiche di prima linea  {.tabset .tabset-fade .tabset-pills}


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}
# runoff %>% count(ds)
```


```{r}

get_table_dat <- function(x, var) {
    
    

x %>% 
        distinct(internal_id, .keep_all = T) %>% 
    group_by({{ var }}) %>% 
    summarize(total_num_ads = n()) %>% 
    drop_na() %>% 
    mutate(total_num_ads = scales::comma(total_num_ads)) %>%
    pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
    mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>% 
    bind_rows(x %>% 
        distinct(internal_id, .keep_all = T) %>% 
        group_by({{ var }}) %>% 
        arrange(desc(total_spend_formatted)) %>% 
        slice(1:3) %>% 
        mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%
        mutate(n_words = str_count(page_name, " ")) %>% 
        mutate(lab = paste0(word(str_remove(page_name, "-"), 1,ifelse(n_words>=2, 3, 2), sep=" "), "<br>(€", total_spend_formatted, ")")) %>% 
        # mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>% 
        select({{ var }}, lab) %>% 
        drop_na() %>% 
        summarize(lab = paste0("<br>", 1:n(), ". ", lab, collapse = "")) %>% 
        pivot_wider(names_from = {{ var }}, values_from = lab) %>% 
        mutate(`Coalizione/Partito` = "Chi ha\nspeso di più"))  %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_num_ads = sum(total_num_ads)) %>% 
            drop_na() %>% 
            mutate(total_num_ads = scales::comma(total_num_ads)) %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
            mutate(`Coalizione/Partito` = "Numero di annunci")) %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_spend_formatted = sum(total_spend_formatted)) %>% 
            mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% 
        mutate(total_spend_formatted = paste0("€", total_spend_formatted)) %>% 
            drop_na() %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_spend_formatted) %>% 
            mutate(`Coalizione/Partito` = "Spesa Totale") ) %>% 
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("Coalizione/Partito") %>% 
    set_names(.[nrow(.),] %>% as.character()) %>% 
    slice(1:(n()-1)) 
    
}


get_table_dat(lombardy30, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0039aa",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Terzo Polo"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))




```




##### `r last7days_string` (Ultimi 7 giorni)


```{r}

get_table_dat(lombardy7, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0039aa",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Terzo Polo"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}

add_ribbons <- function(x, adv, col) {
   x %>% 
  tab_options(table.width = pct(100)) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = col,
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = adv
    ))
}

get_table_dat(lombardy30, party) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538()  %>%
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    add_ribbons("Majorino Presidente", "#febb00") %>%
    add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    add_ribbons("Più Europa Radicali Volt", "#ffd700") %>%
    add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r}


get_table_dat(lombardy7, party) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  # left_join(lab_dat  %>% 
  #               filter(election == "Lombardy") %>% 
  # mutate(`Coalizione/Partito` = ifelse(str_detect(party,  "Azione"), "Azione - Italia Viva", party)) %>% 
  #   distinct(`Coalizione/Partito`, coalition) %>% mutate(Coalizione = `Coalizione/Partito`)) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538()  %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    add_ribbons("Majorino Presidente", "#febb00") %>%
    add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    add_ribbons("Più Europa Radicali Volt", "#ffd700") %>%
    add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    )) # %>%
  # gtExtras::gt_merge_stack(col1 = Coalizione, col2 = coalition)
```


```{r}
# library(gtExtras)
# team_df <- readRDS(url("https://github.com/nflverse/nflfastR-data/raw/master/teams_colors_logos.rds"))
# 
# team_df %>%
#   dplyr::select(team_nick, team_abbr, team_conf, team_division, team_wordmark) %>%
#   head(8) %>%
#   gt(groupname_col = "team_conf") %>%
#   gt_merge_stack(col1 = team_nick, col2 = team_division)
```


### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

#####  `r last30days_string` (Ultimi 30 giorni)

```{r}
# runoff %>% count(ds)
```


```{r}

get_table_dat(lazio30, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#fff44f",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione Movimento 5 Stelle"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



##### `r last7days_string` (Ultimi 7 giorni)


```{r}

get_table_dat(lazio7, coalition) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))   %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#ef3e3e",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-sinistra"
    )) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#0a6be1",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione di centro-destra"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = "#fff44f",
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Numero di inserzionisti`,
      rows = "Coalizione Movimento 5 Stelle"
    ))%>%
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}

get_table_dat(lazio30, party) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Europa"), "Piu Europa Radicali Volt", `Coalizione/Partito`)) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Piu Europa Radicali Volt", "#ffd700") %>% 
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    # add_ribbons("Majorino Presidente", "#febb00") %>%
    # add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
    add_ribbons("UdC", "#87cefa") %>% 
    add_ribbons("Lista Civica D'Amato", "#0062a6") %>% 
    add_ribbons("Lista Civica Rocca", "#e20613") %>% 
    add_ribbons("Polo Progressista", "#e52728") %>% 
    add_ribbons("Demos", "#449192") %>% 
    add_ribbons("Psi", "#dc143c")  %>% 
    
     
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r}

get_table_dat(lazio7, party) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Azione"), "Azione - Italia Viva", `Coalizione/Partito`)) %>% 
  mutate(`Coalizione/Partito` = ifelse(str_detect(`Coalizione/Partito`,  "Europa"), "Piu Europa Radicali Volt", `Coalizione/Partito`)) %>% 
  arrange(desc(parse_number(`Spesa Totale`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>% 
  tab_options(table.width = pct(100))  %>%
    add_ribbons("Piu Europa Radicali Volt", "#ffd700") %>% 
    add_ribbons("Lega", "#008000") %>%
    add_ribbons("Azione - Italia Viva", "#0039aa") %>%
    add_ribbons("PD", "#ef1c27") %>%
    add_ribbons("FdI", "#03386a") %>%
    # add_ribbons("Majorino Presidente", "#febb00") %>%
    # add_ribbons("Fontana Presidente", "#363a91") %>%
    add_ribbons("Forza Italia", "#0087dc") %>%
    # add_ribbons("Moratti Presidente", "#0a7d98") %>% 
    add_ribbons("M5S", "#fff44f") %>% 
    add_ribbons("Verdi-Sinistra", "#bd3758") %>% 
    add_ribbons("Noi moderati e Rinascimento", "#5683b3") %>% 
    add_ribbons("UdC", "#87cefa") %>% 
    add_ribbons("Lista Civica D'Amato", "#0062a6") %>% 
    add_ribbons("Lista Civica Rocca", "#e20613") %>% 
    add_ribbons("Polo Progressista", "#e52728") %>% 
    add_ribbons("Demos", "#449192") %>% 
    add_ribbons("Psi", "#dc143c")  %>% 
    
     
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "lightgrey",
      weight = px(0.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = everything(),
      rows = everything()
    ))
```



<!-- ### Principali partiti politici  {.tabset .tabset-fade .tabset-pills} -->

<!-- #### Nov 30th - Dec 6th 2022 (Last 30 Days) -->

<!-- ```{r} -->
<!-- # runoff %>% count(ds) -->
<!-- ``` -->


<!-- ```{r} -->

<!-- main30 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--     group_by(coalition) %>%  -->
<!--     summarize(total_num_ads = n()) %>%  -->
<!--     drop_na() %>%  -->
<!--     mutate(total_num_ads = scales::comma(total_num_ads)) %>% -->
<!--     pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--     mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>%  -->
<!-- bind_rows( -->
<!--     main30 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--         group_by(coalition) %>%  -->
<!--         arrange(desc(total_spend_formatted)) %>%  -->
<!--         slice(1:3) %>%  -->
<!--         mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% -->
<!--         mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>%  -->
<!--         select(coalition, lab) %>%  -->
<!--         drop_na() %>%  -->
<!--         summarize(lab = paste0("<br>", 1:3, ". ", lab, collapse = "")) %>%  -->
<!--         pivot_wider(names_from = coalition, values_from = lab) %>%  -->
<!--         mutate(`Coalizione/Partito` = "Chi ha speso di più") -->
<!-- )  %>%  -->

<!--     bind_rows( -->
<!--         main30 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_num_ads = sum(total_num_ads)) %>%  -->
<!--             drop_na() %>%  -->
<!--             mutate(total_num_ads = scales::comma(total_num_ads)) %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Numero di annunci") -->
<!--     )%>%  -->
<!--     bind_rows( -->
<!--         main30 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_spend_formatted = sum(total_spend_formatted)) %>%  -->
<!--             mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%  -->
<!--             drop_na() %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_spend_formatted) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Spesa Totale (Euro)")  -->
<!--     ) %>%  -->
<!--     t() %>%  -->
<!--     as.data.frame() %>%  -->
<!--     rownames_to_column("Coalizione/Partito") %>%  -->
<!--     set_names(.[nrow(.),] %>% as.character()) %>%  -->
<!--     slice(1:(n()-1)) %>%  -->



<!--   gt( -->
<!--     rowname_col = "Coalizione/Partito" -->
<!--     # groupname_col = "group" -->
<!--   ) %>%  -->
<!--   fmt_markdown(columns = everything()) -->
<!-- ``` -->



<!-- #### Nov 30th - Dec 6th 2022 (Last 7 Days) -->


<!-- ```{r} -->

<!-- main7 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--     group_by(coalition) %>%  -->
<!--     summarize(total_num_ads = n()) %>%  -->
<!--     drop_na() %>%  -->
<!--     mutate(total_num_ads = scales::comma(total_num_ads)) %>% -->
<!--     pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--     mutate(`Coalizione/Partito` = "Numero di inserzionisti") %>%  -->
<!-- bind_rows( -->
<!--     main7 %>%  -->
<!--         distinct(internal_id, .keep_all = T) %>%  -->
<!--         group_by(coalition) %>%  -->
<!--         arrange(desc(total_spend_formatted)) %>%  -->
<!--         slice(1:3) %>%  -->
<!--         mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% -->
<!--         mutate(lab = paste0(page_name, " (€", total_spend_formatted, ")")) %>%  -->
<!--         select(coalition, lab) %>%  -->
<!--         drop_na() %>%  -->
<!--         summarize(lab = paste0("<br>", 1:3, ". ", lab, collapse = "")) %>%  -->
<!--         pivot_wider(names_from = coalition, values_from = lab) %>%  -->
<!--         mutate(`Coalizione/Partito` = "Chi ha speso di più") -->
<!-- )  %>%  -->

<!--     bind_rows( -->
<!--         main7 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_num_ads = sum(total_num_ads)) %>%  -->
<!--             drop_na() %>%  -->
<!--             mutate(total_num_ads = scales::comma(total_num_ads)) %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_num_ads) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Numero di annunci") -->
<!--     )%>%  -->
<!--     bind_rows( -->
<!--         main7 %>%  -->
<!--             distinct(internal_id, .keep_all = T) %>%  -->
<!--             group_by(coalition) %>%  -->
<!--             summarize(total_spend_formatted = sum(total_spend_formatted)) %>%  -->
<!--             mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%  -->
<!--             drop_na() %>%  -->
<!--             pivot_wider(names_from = coalition, values_from = total_spend_formatted) %>%  -->
<!--             mutate(`Coalizione/Partito` = "Spesa Totale (Euro)")  -->
<!--     ) %>%  -->
<!--     t() %>%  -->
<!--     as.data.frame() %>%  -->
<!--     rownames_to_column("Coalizione/Partito") %>%  -->
<!--     set_names(.[nrow(.),] %>% as.character()) %>%  -->
<!--     slice(1:(n()-1)) %>%  -->



<!--   gt( -->
<!--     rowname_col = "Coalizione/Partito" -->
<!--     # groupname_col = "group" -->
<!--   ) %>%  -->
<!--   fmt_markdown(columns = everything()) -->
<!-- ``` -->



## Spesa, suddivisa per metodo di targeting {.tabset .tabset-fade .tabset-pills}

Quanto hanno speso le campagne per diversi metodi di targeting?


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)



```{r, fig.width=11, fig.height=5, dpi=300}


col_each_lombardy30 <- lombardy30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


# calc_targeting()

# 
# spend_on_each_lombardy30 %>% 
#     ggplot(aes(target, perc)) +
#     geom_col(aes(fill = coalition)) +
#     coord_flip() +
#     facet_wrap(~coalition) +
#     theme(legend.position = "none")

plot_geography <- function(x) {
    
gg <- x %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra")))

the_order <- gg %>% 
    complete(coalition, target, fill = list(perc= 0)) %>% 
    filter(coalition == "Coalizione di centro-sinistra")  %>% 
    mutate(target = fct_reorder(target, perc, .desc = F)) %>% 
    pull(target) %>% levels

gg %>% 
    mutate(target = fct_relevel(target, the_order)) %>% 
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = coalition)) +
    coord_flip() +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100)

}

plot_geography(col_each_lombardy30)

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=5, dpi=300}

col_each_lombardy7 <- lombardy7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



plot_geography(col_each_lombardy7)

```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width=11, fig.height=9, dpi=300}
par_each_lombardy30 <- lombardy30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


plot_geography_parties <- function(x) {
    
gg <- x %>% 
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc)) 

the_order <- gg %>% 
    complete(party, target, fill = list(perc= 0)) %>% 
    filter(party == "Azione – Italia Viva")  %>% 
    mutate(target = fct_reorder(target, perc, .desc = F)) %>% 
    pull(target) %>% levels

gg %>% 
    mutate(target = fct_relevel(target, the_order)) %>% 
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = party),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100) +
    scale_fill_parties()

}

# color_dat1 <- tibble(colors = c("#008000", "#0039aa", "#ef1c27", "#03386a", "#febb00", "#363a91", "#0087dc", "#ffd700", "#0a7d98", "#fff44f", "#bd3758", "#5683b3"),
#                     party = c("Lega", "Azione – Italia Viva", "PD", "FdI", "Majorino Presidente", "Fontana Presidente", "Forza Italia", "Più Europa Radicali Volt", "Moratti Presidente", "M5S", "Verdi-Sinistra", "Noi moderati e Rinascimento"))
# 
# color_dat2 <- tibble(colors = c("#ffd700", "#008000", "#0039aa", "#ef1c27", "#03386a", "#0087dc", "#fff44f", "#bd3758", "#5683b3", "#87cefa", "#0062a6", "#e20613", "#e52728", "#449192", "#dc143c"),
#                     party = c("Più Europa Radicali Volt", "Lega", "Azione – Italia Viva", "PD", "FdI", "Forza Italia", "M5S", "Verdi-Sinistra", "Noi moderati e Rinascimento", "UdC", "Lista Civica D'Amato", "Lista Civica Rocca", "Polo Progressista", "Demos", "Psi"))

color_dat <- structure(list(colors = c("#008000", "#0039aa", "#ef1c27", "#03386a", 
"#febb00", "#363a91", "#0087dc", "#ffd700", "#0a7d98", "#fff44f", 
"#bd3758", "#5683b3", "#87cefa", "#0062a6", "#e20613", "#e52728", 
"#449192", "#dc143c"), party = c("Lega", "Azione – Italia Viva", 
"PD", "FdI", "Majorino Presidente", "Fontana Presidente", "Forza Italia", 
"Più Europa Radicali Volt", "Moratti Presidente", "M5S", "Verdi-Sinistra", 
"Noi moderati e Rinascimento", "UdC", "Lista Civica D'Amato", 
"Lista Civica Rocca", "Polo Progressista", "Demos", "Psi")), row.names = c(NA, 
-18L), class = c("tbl_df", "tbl", "data.frame"))

scale_fill_parties <- function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(color_dat$colors, color_dat$party), 
        ...
    )
}
scale_color_parties <- function(...){
    ggplot2:::manual_scale(
        'color', 
        values = setNames(color_dat$colors, color_dat$party), 
        ...
    )
}


color_col_dat <- tibble(colors = c("#ef3e3e", "#0a6be1", "#fff44f", "#0039aa"),
                    party = c("Coalizione di centro-sinistra", "Coalizione di centro-destra", "Coalizione Movimento 5 Stelle", "Terzo Polo"))

scale_fill_coalition <- function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(color_col_dat$colors, color_col_dat$party), 
        ...
    )
}
scale_color_coalitio <- function(...){
    ggplot2:::manual_scale(
        'color', 
        values = setNames(color_col_dat$colors, color_col_dat$party), 
        ...
    )
}

plot_geography_parties(par_each_lombardy30)

```


```{r, fig.width=11, fig.height=9, dpi=300, eval =F}
par_each_lombardy30 %>%# count(party)
  filter(perc >= 0.1) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAFIA: Italia",
    target == "regions" ~ "GEOGRAFIA: Regioni",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interessi",
    target == "age" ~ "Eta",
    target == "zips" ~ "GEOGRAFIA: Codice Postale",
    target == "CITY" ~ "GEOGRAFIA: Citta",
    target == "language" ~ "Lingua",
    target == "gender" ~ "Genere",
    target == "COMUNE" ~ "GEOGRAFIA: Comune",
    target == "electoral_districts" ~ "GEOGRAFIA: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAFIA: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAFIA: Quartiere",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  %>% 
    mutate(target = fct_reorder(target, perc, .desc = T)) %>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Terzo Polo",
    #                               "Coalizione di centro-destra"))) %>%
    ggplot(aes(party, perc)) +
    geom_col(aes(fill = party)) +
    coord_flip() +
    facet_wrap(~target) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))  +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = coalition),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 100) +
    scale_fill_parties()



```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lombardy7 <- lombardy7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



plot_geography_parties(par_each_lombardy7)

```

### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)



```{r, fig.width=11, fig.height=5, dpi=300}


col_each_lazio30 <- lazio30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


# calc_targeting()

# 
# spend_on_each_lazio30 %>% 
#     ggplot(aes(target, perc)) +
#     geom_col(aes(fill = coalition)) +
#     coord_flip() +
#     facet_wrap(~coalition) +
#     theme(legend.position = "none")



# debugonce(plot_geography)
plot_geography(col_each_lazio30) +
    scale_fill_coalition()

```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=5, dpi=300}

col_each_lazio7 <- lazio7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(coalition, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })




plot_geography(col_each_lazio7)  +
    scale_fill_coalition()


```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lazio30 <- lazio30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })



plot_geography_parties(par_each_lazio30)


```




##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width=11, fig.height=9, dpi=300}

par_each_lazio7 <- lazio7 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "EUR") %>% 
    group_split(party, election) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(coalition = .x$coalition[1],
                   party = .x$party[1],
                   election = .x$election[1])
    })


plot_geography_parties(par_each_lazio7)


```

## Interessi e Audience {.tabset .tabset-fade .tabset-pills}

Qui mostriamo i *pubblici più contestati*, ovvero quelli in cui tutte le coalizioni/partiti hanno investito somme considerevoli per competere nella targettizzazione degli elettori con gli stessi interessi. La maggior parte (ma non tutti) di questi pubblici sono "interessi", ovvero i partiti si sono rivolti alle persone interessate a "Libri" o "Politica".


### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}

#### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width  = 10, fig.height=15}
get_contested_graph <- function(ppp, col_string, col_colors) {
    
    
interest_targeting <-  ppp %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(type == "detailed") %>%
    # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
    mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>%
    mutate(total_spend = total_spend * total_spend_pct) %>%
    filter(main_currency == "EUR")  %>%
    # left_join(page_names %>% select(internal_id = page_id, page_name) %>% distinct(internal_id, .keep_all =T)) %>%
    # left_join(us_advertisers %>% rename(internal_id = page_id)) %>%
    # drop_na(left_vs_right) %>%
    mutate(value = paste0(detailed_type,": ", value)) %>% 
    group_by(coalition, value, is_exclusion, detailed_type) %>%
    summarise(total_spend = sum(total_spend)) %>%
    ungroup() %>%
    arrange(desc(total_spend)) 

contested_dat <- interest_targeting %>% 
    filter(coalition != "Unione Popolare") %>% 
  filter(!is_exclusion) %>% 
  # filter(total_spend >= 40000) %>% 
  filter(total_spend >= 100) %>%
  add_count(value) %>% 
  filter(n == 3) %>% 
  group_by(value) %>% 
  mutate(total_spenderino = sum(total_spend)) %>% 
  mutate(perc = total_spend/total_spenderino) %>%
  mutate(value = str_remove_all(value, "INTERESTS: |DEMOGRAPHICS: |BEHAVIORS: ")) %>% 
  mutate(value = str_replace_all(value, " \\s*\\([^\\)]+\\)", ""))


the_order <- contested_dat %>% 
  filter(coalition == "Coalizione di centro-destra") %>%   arrange(desc(perc)) %>% 
  pull(value) %>% 
  unique()

lab_dat <- contested_dat %>% 
  # distinct(value, .keep_all = T) %>% 
  filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(labb = paste0("€", scales::comma(round(total_spenderino)))) %>% 
  select(coalition, value, labb)



contested_dat %>% #count(coalition) %>% pull(coalition) %>% unique() %>% dput()
  # mutate(the_order = )
  left_join(lab_dat) %>% 
  mutate(value = factor(value, the_order)) %>% 
  mutate(coalition = factor(coalition, col_string)) %>%
  # filter()
  ggplot(aes(value, perc)) +
  geom_col(aes(fill = coalition), position = position_stack(), alpha = 0.8) +
  coord_flip() +
  geom_label(aes(label = labb),y=1.225,
            position = position_stack(vjust = 0.5),
            hjust = 1, label.size = NA,
            size = 4) + expand_limits(y = 1.2) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  # scale_fill_manual("Page Groups", values = c("#ff2700", "#008fd5")) +
  ggthemes::theme_hc() +
  labs(x = "Targeting criteria", y = "% of budget spent on targeting method", #title = "Contested targeted interests (US midterms 2022)", subtitle = " ", 
       caption = "Source: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).") +
  theme(legend.position = "bottom", plot.title = element_text(size = 28, face = "bold", hjust = 1.25), text=element_text(family="mono", face = "bold"), plot.caption = element_text(hjust = -1.7)) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))  +
    scale_fill_manual(values = col_colors)
    
}


# c("Terzo Polo", "Coalizione di centro-destra", "Coalizione di centro-sinistra", 
# "Unione Popolare")
```


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lombardy30, c("Coalizione di centro-sinistra", "Terzo Polo", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#0039aa", "#0a6be1") %>% rev)
```


#### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width  = 10, fig.height=15}

get_contested_graph(lombardy7, c("Coalizione di centro-sinistra", "Terzo Polo", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#0039aa", "#0a6be1") %>% rev)
```

### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lazio30, c("Coalizione di centro-sinistra", "Coalizione Movimento 5 Stelle", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#fff44f", "#0a6be1") %>% rev)

```


#### `r last7days_string` (Ultimi 7 giorni)


```{r, fig.width  = 10, fig.height=15}
get_contested_graph(lazio7, c("Coalizione di centro-sinistra", "Coalizione Movimento 5 Stelle", "Coalizione di centro-destra") %>% rev,
                    c("#ef3e3e", "#fff44f", "#0a6be1") %>% rev)
```


## Targeting di Etá {.tabset .tabset-fade .tabset-pills}

### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}
get_targ_perc <- function(x, var) {
    
x <<- x
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()


x %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  filter(type == var) %>%   
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
    
}


age_targeting <- lombardy30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(get_targ_perc, "age")
    
# age_targeting %>% 
#      mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
#                                   "Terzo Polo",
#                                   "Coalizione di centro-destra"))) %>% 
#     filter(!(value %in% 13:17)) %>% 
#     ggplot(aes(value, perc, fill = coalition)) +
#     geom_col() +
#     facet_wrap(~coalition) +
#     ggthemes::theme_hc() +
#     scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
#     theme(legend.position = "none") +
#     scale_y_continuous(labels = scales::percent) +
#     scale_x_discrete(breaks = c("18", "24",
#                                 "34", "44",
#                                 "54", "65+")) +
#     labs(y = "% Budget Spend on Age")


# lombardy30 %>% 
#     group_split(coalition, election) %>% 
#     map_dfr(get_targ_perc, "age")
    
age_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, coalition) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
    mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+") %>% rev)) %>% 
    ggplot(aes(age_groups, perc, fill = coalition)) +
    geom_col(width = 0.5) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_text(size = 3.5, color = "white",
             aes(y = perc - 0.19, label = paste0(round(perc*100, 1), "%")))
    
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


age_targeting7 <- lombardy7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(get_targ_perc, "age")
    
age_targeting7 %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, coalition) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
    mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+") %>% rev)) %>% 
  mutate(perc = spend_per/total_budget)  %>% 
    ggplot(aes(age_groups, perc, fill = coalition)) +
    geom_col(width = 0.5) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_text(size = 3.5, color = "white",
             aes(y = perc - 0.19, label = paste0(round(perc*100, 1), "%")))
    
```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


age_targeting <- lombardy30 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "age")

age_targeting %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, party) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+"))) %>% 
    # filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party), alpha = 0.8)  +
    facet_wrap(~age_groups) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Groups") +
    coord_flip() +
    labs(x = "Age\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


age_targeting <- lombardy7 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "age")

age_targeting %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, party) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+"))) %>% 
    # filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party), alpha = 0.8)  +
    facet_wrap(~age_groups) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Groups") +
    coord_flip() +
    labs(x = "Age\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
```


### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

# debugonce(get_age_perc)
age_targeting <- lazio30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(get_targ_perc, "age")
    
   
age_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione Movimento 5 Stelle",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, coalition) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+") %>% rev)) %>% 
    ggplot(aes(age_groups, perc, fill = coalition)) +
    geom_col(width = 0.5) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#fff44f", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_text(size = 3.5, 
             aes(color = coalition, y = perc - 0.19, label = paste0(round(perc*100, 1), "%"))) +
    scale_color_manual(values = c("white", "black", "white"))
    
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

# debugonce(get_age_perc)
age_targeting7 <- lazio7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(get_targ_perc, "age")
    
   
age_targeting7 %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione Movimento 5 Stelle",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, coalition) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+") %>% rev)) %>% 
    ggplot(aes(age_groups, perc, fill = coalition)) +
    geom_col(width = 0.5) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#fff44f", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")   +
  geom_text(size = 3.5, 
             aes(color = coalition, y = perc - 0.19, label = paste0(round(perc*100, 1), "%"))) +
    scale_color_manual(values = c("white", "black", "white"))
#     
# x %>% 
#     filter(type == "age") %>% 
#     count(page_name, value, sort = T)
# 
# total_sppppeen <- x %>% 
# # filter(coalition == "Coalizione di centro-destra") %>% 
#   mutate(total_spend = total_spend_formatted) %>%
#   distinct(internal_id, .keep_all = T)  %>%
#   # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
#   mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
#   select(internal_id, total_spend) %>% 
#   arrange(desc(total_spend)) %>% 
#   summarize(total_budget = sum(total_spend)) %>% 
#   ungroup()
# 
# 
# x %>% 
#   mutate(total_spend = total_spend_formatted) %>%
#   mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
#   # filter(coalition == "Coalizione di centro-destra") %>%  
#   filter(type == "age") %>%   
#   # filter(total_spend_pct != 0) %>% 
#   group_by(internal_id) %>%
#   mutate(n_ages = n()) %>% #count(n_ages, sort = T)
#   ungroup()%>% 
#   mutate(spend_per = total_spend * total_spend_pct) %>% 
#   group_by(value) %>% 
#   summarize(spend_per = sum(spend_per)) %>% 
#   bind_cols(total_sppppeen) %>% 
#   mutate(perc = spend_per/total_budget) %>% 
#             mutate(coalition = x$coalition[1],
#                    party = x$party[1],
#                    election = x$election[1])
#     
# x %>%
#     filter(value == "25") %>% 
#     distinct(internal_id, .keep_all = T) %>% 
#   mutate(total_spend = ifelse(total_spend_formatted == 100, 1, total_spend_formatted)) %>% 
#   mutate(spend_per = total_spend * total_spend_pct) %>% 
#     mutate(tottaaal = sum(spend_per))  %>% 
#     select(tottaaal, spend_per, total_spend, total_spend_pct, everything()) 
```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

age_targeting <- lazio30 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "age")

age_targeting %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, party) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+"))) %>% 
    # filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party), alpha = 0.8)  +
    facet_wrap(~age_groups) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Groups") +
    coord_flip() +
    labs(x = "Age\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

age_targeting <- lazio7 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "age")

age_targeting %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, party) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
        mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+"))) %>% 
    # filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party), alpha = 0.8)  +
    facet_wrap(~age_groups) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Groups") +
    coord_flip() +
    labs(x = "Age\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
```


## Targeting di Gender {.tabset .tabset-fade .tabset-pills}

### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


gender_targeting <- lombardy30 %>% 
group_split(coalition, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% "All")) %>% 
    ggplot(aes(value, perc)) +
    geom_col(width = 0.5, aes(fill = coalition)) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_label(size = 3.5, color = "black",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))
    
```

##### `r last7days_string` (Ultimi 7 giorni)

```{r}

gender_targeting <- lombardy7 %>% 
group_split(coalition, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% "All")) %>% 
    ggplot(aes(value, perc)) +
    geom_col(width = 0.5, aes(fill = coalition)) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_label(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))
    
```


#### Per Partito {.tabset .tabset-fade .tabset-pills}


##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

gender_targeting <- lombardy30 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
    filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party), alpha = 0.8)  +
    facet_wrap(~value) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
    
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r}
gender_targeting <- lombardy7 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
    filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party)) +
    facet_wrap(~value) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
    
```


### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r}

gender_targeting <- lazio30 %>% 
group_split(coalition, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione Movimento 5 Stelle",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% "All")) %>% 
    ggplot(aes(value, perc)) +
    geom_col(width = 0.5, aes(fill = coalition)) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_label(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_coalition()
    
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r}

gender_targeting <- lazio7 %>% 
group_split(coalition, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Coalizione Movimento 5 Stelle",
                                  "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% "All")) %>% 
    ggplot(aes(value, perc)) +
    geom_col(width = 0.5, aes(fill = coalition)) +
    facet_wrap(~coalition) +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_label(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))  +
    scale_fill_coalition()
    
```


#### Per Partito {.tabset .tabset-fade .tabset-pills}


##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

gender_targeting <- lazio30 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
    filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party)) +
    facet_wrap(~value) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
    
```



##### `r last7days_string` (Ultimi 7 giorni)


```{r, fig.width= 8, fig.height=5, dpi = 300}

gender_targeting <- lazio7 %>% 
group_split(party, election) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
    filter(value != "All") %>%
    # filter(value == "Women") %>% 
    arrange(desc(perc)) %>% 
    mutate(party = fct_reorder(party, perc)) %>% 
    ggplot(aes(party, perc)) +
    geom_col(width = 0.5, aes(fill = party)) +
    facet_wrap(~value) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))+
    scale_fill_parties()
    
```

## Targeting dei Livelli di Educazione

### Elezioni regionali in Lombardia {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


calc_edu_perc <- function(x) {
    
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()

x %>% 
    filter(type == "detailed") %>%
    filter(detailed_type == "DEMOGRAPHICS") %>% 
    # count(value, sort = T) %>% 
    filter(str_detect(value, "grad school|degree|	|Master|[c|C]ollege|degree|[H|h]igh school|Professional degree")) %>% 
    filter(str_detect(value, "Wine", negate = T)) %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
}

lombardy30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))
    


    
```

##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lombardy7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%")))
    


```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lombardy30 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party) +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
    
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lombardy7 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party) +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
    
```


### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}


#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width= 8, fig.height=5, dpi = 300}

lazio30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")  +
  geom_text(size = 3.5, color = "black",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))
    
```


##### `r last7days_string` (Ultimi 7 giorni)


```{r, fig.width= 8, fig.height=5, dpi = 300}

lazio7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")  +
  geom_text(size = 3.5, color = "black",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))
```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}
lazio30 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party) +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lazio7 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_edu_perc) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party) +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
    
```


## Targeting di Professioni

### Elezioni regionali in Lombardia  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}


calc_jobs_perc <- function(x) {
    
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()

x %>% 
    filter(type == "detailed") %>%
    filter(detailed_type == "DEMOGRAPHICS") %>% 
    # count(value, sort = T) %>% 
    filter(str_detect(value, "grad school|degree|	|Master|[c|C]ollege|degree|[H|h]igh school|Professional degree", negate = T)) %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 100, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
}

lombardy30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))  +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
    


    
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lombardy7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))  +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
    



```


#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 10, fig.height=9, dpi = 300}

lombardy30 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%"))) +
    scale_fill_parties() +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
```


##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 10, fig.height=9, dpi = 300}

lombardy7 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%"))) +
    scale_fill_parties() +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
```



### Elezioni regionali in Lazio  {.tabset .tabset-fade .tabset-pills}

#### Per Coalizione  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lazio30 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))  +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
    
```



##### `r last7days_string` (Ultimi 7 giorni)

```{r, fig.width= 8, fig.height=5, dpi = 300}

lazio7 %>% 
    group_split(coalition, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  "Terzo Polo",
                                  "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = coalition)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~coalition) +
    coord_flip() +
    ggthemes::theme_hc() +
    scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))   +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
    



```

#### Per Partito  {.tabset .tabset-fade .tabset-pills}

##### `r last30days_string` (Ultimi 30 giorni)


```{r, fig.width= 10, fig.height=9, dpi = 300}

lazio30 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%"))) +
    scale_fill_parties() +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
```


##### `r last7days_string` (Ultimi 7 giorni)



```{r, fig.width= 10, fig.height=9, dpi = 300}

lazio7 %>% 
    group_split(party, election) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = fct_reorder(value, perc)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%"))) +
    scale_fill_parties() +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 22))
```


